generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Users table
model User {
  id                String             @id @default(uuid())
  email             String             @unique
  password          String
  name              String
  role              Role               @default(PATIENT)
  isVerified        Boolean            @default(false)
  verificationToken String?
  resetToken        String?
  resetTokenExpiry  DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  // Relations
  healthProfile     HealthProfile?
  assessments       Assessment[]
  medicalDocuments  MedicalDocument[]
  appointmentsAsPatient Appointment[] @relation("PatientAppointments")
  appointmentsAsDoctor  Appointment[] @relation("DoctorAppointments")
  sentMessages      Message[]          @relation("SentMessages")
  receivedMessages  Message[]          @relation("ReceivedMessages")
  doctorProfile     DoctorProfile?
  doctorAssessments CallAssessment[]   @relation("DoctorAssessments")
  patientAssessments CallAssessment[]  @relation("PatientAssessments")
  
  @@index([email])
}

enum Role {
  PATIENT
  DOCTOR
}

// Doctor Profile
model DoctorProfile {
  id             String   @id @default(uuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  qualification  String?
  specialties    String[] // Array of strings
  about          String?  @db.Text
  profilePicture String?
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// Health Profiles
model HealthProfile {
  id                    String    @id @default(uuid())
  userId                String    @unique
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  dob                   DateTime?
  gender                String?
  bloodType             String?
  conditions            String?   @db.Text
  allergies             String?   @db.Text
  emergencyContactName  String?
  emergencyContactPhone String?
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}

// Medication Assessments
model Assessment {
  id                    String   @id @default(uuid())
  userId                String
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  medications           Json     // Array of medication objects
  conditions            String?  @db.Text
  riskPercentage        Int
  summary               String   @db.Text
  recommendedSpecialist String?
  alternatives          Json     // Array of alternative suggestions
  recommendations       Json     // Array of lifestyle recommendations
  
  createdAt             DateTime @default(now())
  
  @@index([userId])
}

// Medical Documents
model MedicalDocument {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name        String
  size        Int
  mimeType    String
  path        String   // File path on server
  
  uploadDate  DateTime @default(now())
  
  @@index([userId])
}

// Appointments
model Appointment {
  id            String   @id @default(uuid())
  patientId     String
  patient       User     @relation("PatientAppointments", fields: [patientId], references: [id], onDelete: Cascade)
  
  doctorId      String
  doctor        User     @relation("DoctorAppointments", fields: [doctorId], references: [id], onDelete: Cascade)
  
  appointmentDate DateTime
  appointmentTime String   // HH:MM format
  reason          String?  @db.Text
  status          AppointmentStatus @default(PENDING)
  notes           String?  @db.Text
  
  // Reschedule fields
  rescheduleDate   DateTime?
  rescheduleTime   String?
  rescheduleReason String?
  rescheduleStatus RescheduleStatus? @default(PENDING)
  
  // Video call tracking
  hasHadVideoCall  Boolean  @default(false)
  callDuration     Int?     // Duration in seconds

  // Soft Delete flags
  doctorDeleted    Boolean  @default(false)
  patientDeleted   Boolean  @default(false)
  
  // Relations
  callAssessments  CallAssessment[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([patientId])
  @@index([doctorId])
  @@index([status])
}

// Messages for doctor-patient communication
model Message {
  id        String   @id @default(uuid())
  senderId  String
  sender    User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  
  receiverId String
  receiver  User     @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  
  content   String?  @db.Text  // Optional for file-only messages
  isRead    Boolean  @default(false)
  isDelivered Boolean @default(false)
  
  // File attachment fields
  hasAttachment Boolean @default(false)
  fileName      String?
  fileSize      Int?
  fileMimeType  String?
  filePath      String?
  
  // Deletion tracking
  deletedForEveryone Boolean @default(false)
  deletedBy          String[] @default([])  // Array of user IDs who deleted this message
  
  createdAt DateTime @default(now())
  
  @@index([senderId])
  @@index([receiverId])
  @@index([createdAt])
}

// Call Assessments - Doctor's post-call reports
model CallAssessment {
  id            String      @id @default(uuid())
  appointmentId String
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  
  doctorId      String
  doctor        User        @relation("DoctorAssessments", fields: [doctorId], references: [id], onDelete: Cascade)
  
  patientId     String
  patient       User        @relation("PatientAssessments", fields: [patientId], references: [id], onDelete: Cascade)
  
  assessment    String      @db.Text
  
  createdAt     DateTime    @default(now())
  
  @@index([appointmentId])
  @@index([patientId])
  @@index([doctorId])
  @@index([createdAt])
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum RescheduleStatus {
  PENDING
  APPROVED
  REJECTED
}